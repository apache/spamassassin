#!/bin/bash

WEBDIR=$HOME/spamassassin.taint.org

vers=`build/get_version`

# delete old CVS files
find . -name '.#*' -print | xargs rm -f

make clean ; perl Makefile.PL < /dev/null
make; make; make                # third time lucky!
make text_html_doc
make distcheck

echo $vers > $WEBDIR/latest_version

rm -rf $WEBDIR/doc
tar cf - --exclude=CVS --exclude='.#*' doc | ( cd $WEBDIR ; tar xf - )

rm -rf $WEBDIR/dist
mkdir $WEBDIR/dist
tar cf - --exclude=CVS --exclude='.#*'  \
         --exclude="logs" --exclude='*.tar.gz' --exclude='*.zip' \
         . | ( cd $WEBDIR/dist ; tar xf - )

rm -f Mail-SpamAssassin-$vers.tar.gz Mail-SpamAssassin-$vers.zip
make tardist
cp Mail-SpamAssassin-$vers.tar.gz $WEBDIR/devel

make zipdist
cp Mail-SpamAssassin-$vers.zip $WEBDIR/devel

md5sum Mail-SpamAssassin-$vers.tar.gz \
	> $WEBDIR/devel/Mail-SpamAssassin-$vers.tar.gz.md5
md5sum Mail-SpamAssassin-$vers.zip \
	> $WEBDIR/devel/Mail-SpamAssassin-$vers.zip.md5

( cd $WEBDIR/dist ;
  make clean distclean;
  rm -rf masses/*.log masses/logs
)
# ( cd $WEBDIR/devel && cvs add -kb *SpamAssassin* )

# this can take a while.
echo "Creating 'Changes' file from CVS change log..."
cvs2cl.pl -f Changes -l "-d'>2002-06-18'"

ls -l $WEBDIR/devel
